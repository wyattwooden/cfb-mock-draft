<!DOCTYPE html>
<!-- templates/mock-draft/draft_board.html -->
{% extends 'base.html' %}
{% load roster_tags %}

{% block title %}Draft Board{% endblock %}

{% block content %}
<div class="draft-container">
  
  <!-- Column 1: Player Rankings -->
  <div class="player-rankings">
    <h2 class="section-title">Player Rankings</h2>
    <div class="player-rankings-content">

      <div class="position-filter-bar">
        <a href="#" class="position-filter-button active" data-position="">All</a>
        <a href="#" class="position-filter-button" data-position="QB">QB</a>
        <a href="#" class="position-filter-button" data-position="RB">RB</a>
        <a href="#" class="position-filter-button" data-position="WR">WR</a>
        <a href="#" class="position-filter-button" data-position="TE">TE</a>
        <a href="#" class="position-filter-button" data-position="K">K</a>
      </div>


      <ul class="player-list">
        {% for player in players %}
          <li class="player-item">
            <span class="adp">
              {% if player.adp is not None %}{{ player.adp }}{% else %}-{% endif %}
            </span>
            <strong>{{ player.player_name }}</strong> ({{ player.position }}) {{ player.team }}
            <span class="draft-btn-wrapper">
              <button class="draft-button" data-player-id="{{ player.id }}">Draft</button>
            </span>
          </li>
        {% endfor %}
      </ul>


      <div class="pagination" style="text-align: center; margin-top: 1rem;">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if selected_position %}&position={{ selected_position }}{% endif %}">Previous</a>
        {% endif %}

        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if selected_position %}&position={{ selected_position }}{% endif %}">Next</a>
        {% endif %}
      </div>

    </div>
  </div>

    

    <!-- Column 2: Draft Board -->
    <div class="draft-board">
        <h2 class="section-title">Draft Board</h2>

        <div class="draft-board-grid">
          {% for team_num in num_teams|make_range %}
            <div class="draft-header">
              {% if team_num == user_team_index %}
                Your Team
              {% else %}
                Team {{ team_num|add:1 }}
              {% endif %}
            </div>
          {% endfor %}
        </div>
        
        <!-- Draft grid -->
        {% for round in draft_board %}
          <div class="draft-board-grid">
            {% for cell in round %}
              <div class="draft-cell" data-pick="{{ cell.pick }}">
                {% if cell.player %}
                  <strong>{{ cell.player.name }}</strong><br>
                  {{ cell.player.position }} – {{ cell.player.team }}
                {% else %}
                  <div class="empty-pick">{{ cell.pick }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endfor %}
    </div>
    

  <!-- Column 3: My Team -->
  <div class="your-roster">
    <h2 class="section-title">My Team</h2>
    
    {% if settings %}
    <div class="team-roster">
        <h3>Starters</h3>
        {% for pos, count in settings.items %}
            {% if pos != 'num_teams' and pos != 'bench' and pos != 'num_rounds' %}
                {% if count > 0 %}
                    {% for i in count|make_range %}
                        <div class="roster-spot">
                            <span class="position-label">{{ pos|upper }}</span>
                            <span class="player-slot skeleton-loader"></span>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endif %}
        {% endfor %}

        <h3>Bench</h3>
        {% for i in settings.bench|make_range %}
            <div class="roster-spot">
                <span class="position-label">BN</span>
                <span class="player-slot skeleton-loader"></span>
            </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No roster settings found. Please configure your mock draft first.</p>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {

    // Function to attach draft button listeners (used for initial and refreshed lists)
    function attachDraftButtonListeners(buttons) {
      buttons.forEach(button => {
        button.addEventListener("click", async () => {
          const playerId = button.getAttribute("data-player-id");

          const response = await fetch("{% url 'draft_player_ajax' %}", {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ player_id: playerId })
          });

          const data = await response.json();

          if (data.success) {
            data.updated_cells.forEach(cell => {
              const selector = `[data-pick='${cell.pick}']`;
              const cellEl = document.querySelector(selector);
              if (cellEl) {
                cellEl.innerHTML = `<strong>${cell.name}</strong><br>${cell.position} – ${cell.team}`;
              }
            });

            const playerSlots = document.querySelectorAll('.your-roster .player-slot');
            data.user_roster.forEach((player, index) => {
              if (player && playerSlots[index]) {
                playerSlots[index].textContent = player.name;
              }
            });

            // Remove drafted players (user + auto-drafted) from the list
            data.updated_cells.forEach(cell => {
              const allPlayerItems = document.querySelectorAll(".player-item");
              allPlayerItems.forEach(item => {
                const btn = item.querySelector(".draft-button");
                if (btn && btn.dataset.playerId === String(cell.player_id)) {
                  item.remove();
                }
              });
            });

            // Refresh the player list to exclude auto-drafted players
            const activeFilter = document.querySelector('.position-filter-button.active');
            const position = activeFilter ? activeFilter.dataset.position : "";

            fetch(`/mock/filter_players/?position=${position}`)
              .then(response => response.json())
              .then(data => {
                document.querySelector('.player-list').outerHTML = data.html;
                // Reattach listeners to the new draft buttons
                attachDraftButtonListeners(document.querySelectorAll(".draft-button"));
              });

          } else {
            alert(data.error || "Pick failed.");
          }
        });
      });
    }

    // Attach draft button listeners on page load
    attachDraftButtonListeners(document.querySelectorAll(".draft-button"));

    // Position filter buttons logic
    document.querySelectorAll('.position-filter-button').forEach(button => {
      button.addEventListener('click', function (e) {
        e.preventDefault();

        const position = this.dataset.position;

        fetch(`/mock/filter_players/?position=${position}`)
          .then(response => response.json())
          .then(data => {
            document.querySelector('.player-list').outerHTML = data.html;

            // Reattach draft button listeners to new elements
            attachDraftButtonListeners(document.querySelectorAll(".draft-button"));

            // Update active button styling
            document.querySelectorAll('.position-filter-button').forEach(btn =>
              btn.classList.remove('active')
            );
            this.classList.add('active');
          })
          .catch(err => console.error('Fetch failed', err));
      });
    });

  });
</script>




{% endblock %}

