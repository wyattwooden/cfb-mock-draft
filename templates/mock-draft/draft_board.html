<!DOCTYPE html>
<!-- templates/mock-draft/draft_board.html -->
{% extends 'base.html' %}
{% load roster_tags %}

{% block title %}Draft Board{% endblock %}

{% block content %}
<div class="draft-container">
  
  <!-- Column 1: Player Rankings -->
  <div class="player-rankings">
    <h2 class="section-title">Player Rankings</h2>
    <div class="player-rankings-content">

      <div class="position-filter-bar">
        <a href="#" class="position-filter-button active" data-position="">All</a>
        <a href="#" class="position-filter-button" data-position="QB">QB</a>
        <a href="#" class="position-filter-button" data-position="RB">RB</a>
        <a href="#" class="position-filter-button" data-position="WR">WR</a>
        <a href="#" class="position-filter-button" data-position="TE">TE</a>
        <a href="#" class="position-filter-button" data-position="K">K</a>
      </div>


      <ul class="player-list">
        {% for player in players %}
          <li class="player-item">
            <span class="adp">
              {% if player.adp is not None %}{{ player.adp }}{% else %}-{% endif %}
            </span>
            <strong>{{ player.player_name }}</strong> ({{ player.position }}) {{ player.team }}
            <span class="draft-btn-wrapper">
              <button class="draft-button" data-player-id="{{ player.id }}">Draft</button>
            </span>
          </li>
        {% endfor %}
      </ul>


      <div class="pagination" style="text-align: center; margin-top: 1rem;">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if selected_position %}&position={{ selected_position }}{% endif %}">Previous</a>
        {% endif %}

        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if selected_position %}&position={{ selected_position }}{% endif %}">Next</a>
        {% endif %}
      </div>

    </div>
  </div>

    

    <!-- Column 2: Draft Board -->
    <div class="draft-board">
        <h2 class="section-title">Draft Board</h2>

        <div class="draft-board-grid">
          {% for team_num in num_teams|make_range %}
            <div class="draft-header">
              {% if team_num == user_team_index %}
                Your Team
              {% else %}
                Team {{ team_num|add:1 }}
              {% endif %}
            </div>
          {% endfor %}
        </div>
        
        <!-- Draft grid -->
        {% for round in draft_board %}
          <div class="draft-board-grid">
            {% for cell in round %}
              <div class="draft-cell" data-pick="{{ cell.pick }}">
                {% if cell.player %}
                  <strong>{{ cell.player.name }}</strong><br>
                  {{ cell.player.position }} – {{ cell.player.team }}
                {% else %}
                  <div class="empty-pick">{{ cell.pick }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endfor %}
    </div>
    

  <!-- Column 3: My Team -->
  <div class="your-roster">
    <h2 class="section-title">My Team</h2>

    {% if settings %}
    <div class="team-roster">
      <h3>Starters</h3>
      {% for pos, count in settings.items %}
        {% if pos != 'num_teams' and pos != 'bench' and pos != 'num_rounds' %}
          {% if count > 0 %}
            {% for i in count|make_range %}
              <div class="roster-spot">
                <span class="position-label {{ pos|upper }}">
                  {% if pos == 'flex' %}FLX{% else %}{{ pos|upper }}{% endif %}
                </span>
                <span class="player-slot skeleton-loader" data-position="{{ pos|lower }}"></span>
                <span class="testing">Testing</span>
              </div>
            {% endfor %}
          {% endif %}
        {% endif %}
      {% endfor %}

      <h3>Bench</h3>
      {% for i in settings.bench|make_range %}
        <div class="roster-spot">
          <span class="position-label">BN</span>
          <span class="player-slot skeleton-loader" data-position="bench"></span>
        </div>
      {% endfor %}
    </div>
    {% else %}
      <p>No roster settings found. Please configure your mock draft first.</p>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {

    function attachDraftButtonListeners(buttons) {
      buttons.forEach(button => {
        button.addEventListener("click", async () => {
          const playerId = button.getAttribute("data-player-id");

          const response = await fetch("{% url 'draft_player_ajax' %}", {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ player_id: playerId })
          });

          const data = await response.json();

          if (data.success) {
            // Update draft board cells
            data.updated_cells.forEach(cell => {
              const selector = `[data-pick='${cell.pick}']`;
              const cellEl = document.querySelector(selector);
              if (cellEl) {
                cellEl.innerHTML = `<strong>${cell.name}</strong><br>${cell.position} – ${cell.team}`;
              }
            });

            // Reset all your-roster slots
            const allSlots = document.querySelectorAll(".your-roster .player-slot");
            allSlots.forEach(slot => slot.textContent = "");

            // Refill roster with ordered players
            const positionCounts = {
              qb: 0, rb: 0, wr: 0, te: 0, k: 0, dst: 0, flex: 0, bench: 0
            };
            const maxCounts = {
              qb: document.querySelectorAll('.player-slot[data-position="qb"]').length,
              rb: document.querySelectorAll('.player-slot[data-position="rb"]').length,
              wr: document.querySelectorAll('.player-slot[data-position="wr"]').length,
              te: document.querySelectorAll('.player-slot[data-position="te"]').length,
              k: document.querySelectorAll('.player-slot[data-position="k"]').length,
              dst: document.querySelectorAll('.player-slot[data-position="dst"]').length,
              flex: document.querySelectorAll('.player-slot[data-position="flex"]').length,
              bench: document.querySelectorAll('.player-slot[data-position="bench"]').length
            };

            const flexEligible = ['rb', 'wr', 'te'];

            data.user_roster.forEach(player => {
              let pos = player.position.toLowerCase();

              if (pos in positionCounts && positionCounts[pos] < maxCounts[pos]) {
                const slot = document.querySelectorAll(`.player-slot[data-position="${pos}"]`)[positionCounts[pos]];
                if (slot) slot.innerHTML = `<strong>${player.name}</strong> ${player.team}`;
                positionCounts[pos]++;
              }
              else if (flexEligible.includes(pos) && positionCounts.flex < maxCounts.flex) {
                const slot = document.querySelectorAll(`.player-slot[data-position="flex"]`)[positionCounts.flex];
                if (slot) slot.innerHTML = `<strong>${player.name}</strong> ${player.team}`;
                positionCounts.flex++;
              }
              else if (positionCounts.bench < maxCounts.bench) {
                const slot = document.querySelectorAll(`.player-slot[data-position="bench"]`)[positionCounts.bench];
                if (slot) {
                  slot.innerHTML = `<strong>${player.name}</strong> ${player.team}`;

                  // Update the position label span next to it
                  const parent = slot.closest('.roster-spot');
                  const label = parent.querySelector('.position-label');
                  label.textContent = player.position.toUpperCase(); // change 'BN' to 'WR', 'RB', etc.
                  label.className = `position-label ${player.position.toUpperCase()}`; // update class too
                }
                positionCounts.bench++;
              }
            });

            // Remove drafted players from the pool
            data.updated_cells.forEach(cell => {
              const allPlayerItems = document.querySelectorAll(".player-item");
              allPlayerItems.forEach(item => {
                const btn = item.querySelector(".draft-button");
                if (btn && btn.dataset.playerId === String(cell.player_id)) {
                  item.remove();
                }
              });
            });

            // Refresh player list
            const activeFilter = document.querySelector('.position-filter-button.active');
            const position = activeFilter ? activeFilter.dataset.position : "";

            fetch(`/mock/filter_players/?position=${position}`)
              .then(response => response.json())
              .then(data => {
                document.querySelector('.player-list').outerHTML = data.html;
                attachDraftButtonListeners(document.querySelectorAll(".draft-button"));
              });

          } else {
            alert(data.error || "Pick failed.");
          }
        });
      });
    }

    attachDraftButtonListeners(document.querySelectorAll(".draft-button"));

    document.querySelectorAll('.position-filter-button').forEach(button => {
      button.addEventListener('click', function (e) {
        e.preventDefault();

        const position = this.dataset.position;

        fetch(`/mock/filter_players/?position=${position}`)
          .then(response => response.json())
          .then(data => {
            document.querySelector('.player-list').outerHTML = data.html;
            attachDraftButtonListeners(document.querySelectorAll(".draft-button"));

            document.querySelectorAll('.position-filter-button').forEach(btn =>
              btn.classList.remove('active')
            );
            this.classList.add('active');
          })
          .catch(err => console.error('Fetch failed', err));
      });
    });

  });
</script>

{% endblock %}